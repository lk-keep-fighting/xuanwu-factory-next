generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Project {
  id           String        @id @default(uuid()) @db.Char(36)
  name         String
  identifier   String        @unique
  description  String?       @db.Text
  created_at   DateTime      @default(now()) @db.Timestamp(3)
  updated_at   DateTime      @updatedAt @db.Timestamp(3)
  requirements Requirement[]
  services     Service[]

  @@map("projects")
}

model Service {
  id                      String                   @id @default(uuid()) @db.Char(36)
  project_id              String                   @db.Char(36)
  name                    String
  type                    String                   @db.VarChar(32)
  status                  String                   @default("pending") @db.VarChar(32)
  env_vars                Json?
  resource_limits         Json?
  volumes                 Json?
  network_config          Json?
  git_provider            String?                  @db.VarChar(32)
  git_repository          String?
  git_branch              String?
  git_path                String?
  build_type              String?                  @db.VarChar(32)
  dockerfile_path         String?
  build_args              Json?
  port                    Int?
  replicas                Int?
  command                 String?
  auto_deploy             Boolean                  @default(false)
  built_image             String?
  database_type           String?                  @db.VarChar(32)
  version                 String?
  external_port           Int?
  username                String?
  password                String?
  root_password           String?
  database_name           String?
  volume_size             String?
  internal_host           String?
  internal_connection_url String?
  image                   String?
  tag                     String?
  health_check            Json?
  debug_config            Json?
  created_at              DateTime                 @default(now()) @db.Timestamp(3)
  updated_at              DateTime                 @updatedAt @db.Timestamp(3)
  mysql_config            Json?
  deployments             Deployment[]
  RequirementServiceLink  RequirementServiceLink[]
  RequirementTaskLink     RequirementTaskLink[]
  diagnostics             ServiceDiagnostic[]
  images                  ServiceImage[]
  project                 Project                  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@index([type])
  @@index([status])
  @@map("services")
}

model ServiceImage {
  id           String       @id @default(uuid()) @db.Char(36)
  service_id   String       @db.Char(36)
  image        String       @db.VarChar(512)
  tag          String       @default("latest")
  full_image   String       @db.VarChar(512)
  digest       String?      @db.VarChar(255)
  build_number Int?
  build_status String       @default("building") @db.VarChar(32)
  build_source String       @default("jenkins") @db.VarChar(32)
  build_logs   String?      @db.LongText
  metadata     Json?
  is_active    Boolean      @default(false)
  created_at   DateTime     @default(now()) @db.Timestamp(3)
  updated_at   DateTime     @updatedAt @db.Timestamp(3)
  deployments  Deployment[]
  service      Service      @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@index([service_id])
  @@index([build_status])
  @@map("service_images")
}

model Deployment {
  id               String        @id @default(uuid()) @db.Char(36)
  service_id       String        @db.Char(36)
  service_image_id String?       @db.Char(36)
  status           String        @db.VarChar(32)
  build_logs       String?       @db.LongText
  image_tag        String?
  created_at       DateTime      @default(now()) @db.Timestamp(3)
  completed_at     DateTime?     @db.Timestamp(3)
  service          Service       @relation(fields: [service_id], references: [id], onDelete: Cascade)
  service_image    ServiceImage? @relation(fields: [service_image_id], references: [id])

  @@index([service_id])
  @@index([service_image_id])
  @@index([status])
  @@map("deployments")
}

model SystemConfig {
  id         String   @id @default(uuid()) @db.Char(36)
  key        String   @unique
  value      Json?
  created_at DateTime @default(now()) @db.Timestamp(3)
  updated_at DateTime @updatedAt @db.Timestamp(3)

  @@map("system_configs")
}

model Requirement {
  id                  String                   @id @default(uuid()) @db.Char(36)
  title               String                   @db.VarChar(255)
  project_id          String                   @db.Char(36)
  last_ai_dispatch_at DateTime?                @db.Timestamp(3)
  created_at          DateTime                 @default(now()) @db.Timestamp(3)
  updated_at          DateTime                 @updatedAt @db.Timestamp(3)
  services            RequirementServiceLink[]
  taskLinks           RequirementTaskLink[]
  project             Project                  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@map("requirements")
}

model RequirementServiceLink {
  id             String      @id @default(uuid()) @db.Char(36)
  requirement_id String      @db.Char(36)
  service_id     String      @db.Char(36)
  created_at     DateTime    @default(now()) @db.Timestamp(3)
  requirement    Requirement @relation(fields: [requirement_id], references: [id], onDelete: Cascade)
  service        Service     @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@unique([requirement_id, service_id])
  @@index([service_id])
  @@map("requirement_services")
}

model RequirementTaskLink {
  id                    String      @id @default(uuid()) @db.Char(36)
  requirement_id        String      @db.Char(36)
  ai_employee_id        String
  ai_employee_name      String
  ai_employee_type      String      @db.VarChar(32)
  ai_task_assignment_id String
  task_title            String      @db.VarChar(255)
  project_id            String      @db.Char(36)
  service_id            String?     @db.Char(36)
  branch_name           String?
  expected_outputs      Json?
  priority              String      @db.VarChar(16)
  status                String      @db.VarChar(32)
  result_summary        String?     @db.Text
  created_at            DateTime    @default(now()) @db.Timestamp(3)
  updated_at            DateTime    @updatedAt @db.Timestamp(3)
  requirement           Requirement @relation(fields: [requirement_id], references: [id], onDelete: Cascade)
  service               Service?    @relation(fields: [service_id], references: [id])

  @@index([requirement_id])
  @@index([project_id])
  @@index([service_id])
  @@map("requirement_task_links")
}

model DockerfileTemplate {
  id                 String   @id
  name               String   @db.VarChar(255)
  description        String   @db.Text
  category           String   @db.VarChar(100)
  base_image         String   @db.VarChar(512)
  workdir            String   @default("/app") @db.VarChar(255)
  copy_files         Json?
  install_commands   Json?
  build_commands     Json?
  run_command        String   @db.VarChar(512)
  expose_ports       Json?
  env_vars           Json?
  dockerfile_content String   @db.LongText
  is_active          Boolean  @default(true)
  is_system          Boolean  @default(false)
  created_at         DateTime @default(now()) @db.Timestamp(3)
  updated_at         DateTime @updatedAt @db.Timestamp(3)
  created_by         String?
  updated_by         String?

  @@index([category])
  @@index([is_active])
  @@index([is_system])
  @@map("dockerfile_templates")
}

model ServiceDiagnostic {
  id             String   @id @default(uuid()) @db.Char(36)
  serviceId      String   @db.Char(36)
  diagnosticTime DateTime @db.Timestamp(3)
  conclusion     String   @db.VarChar(255)
  diagnostician  String
  reportCategory String
  reportDetail   String   @db.LongText
  createdAt      DateTime @default(now()) @db.Timestamp(3)
  updatedAt      DateTime @updatedAt @db.Timestamp(3)
  service        Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([diagnosticTime])
  @@map("service_diagnostics")
}
