# ===================================
# 玄武工厂平台 Kubernetes 部署配置
# 基于 xuanwu-factory 命名空间下的 xuanwu-factory-next 实际部署配置
# 最后更新: 2025-11-27
# ===================================

---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: xuanwu-factory
  labels:
    app: xuanwu-factory

---
# ServiceAccount - 用于 kubectl 访问
apiVersion: v1
kind: ServiceAccount
metadata:
  name: xuanwu-factory-next-sa
  namespace: xuanwu-factory

---
# ClusterRole - 定义所需权限
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: xuanwu-factory-pod-exec
rules:
- apiGroups: [""]
  resources: ["pods", "pods/exec"]
  verbs: ["get", "list", "create"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]

---
# ClusterRoleBinding - 绑定权限到 ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: xuanwu-factory-next-pod-exec
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: xuanwu-factory-pod-exec
subjects:
- kind: ServiceAccount
  name: xuanwu-factory-next-sa
  namespace: xuanwu-factory

---
# Deployment - xuanwu-factory-next
apiVersion: apps/v1
kind: Deployment
metadata:
  name: xuanwu-factory-next
  namespace: xuanwu-factory
  labels:
    app: xuanwu-factory-next
spec:
  replicas: 1
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 600
  selector:
    matchLabels:
      app: xuanwu-factory-next
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  template:
    metadata:
      labels:
        app: xuanwu-factory-next
      annotations:
        # 启用 Ephemeral Container 调试支持
        kubectl.kubernetes.io/default-container: xuanwu-factory-next
    spec:
      serviceAccountName: xuanwu-factory-next-sa
      # 可选：添加共享卷用于 init container 方案
      # volumes:
      # - name: debug-tools
      #   emptyDir: {}
      
      # 可选：Init Container 方案（按需启用）
      # initContainers:
      # - name: install-debug-tools
      #   image: busybox:latest
      #   command: ['sh', '-c']
      #   args:
      #   - |
      #     echo "Installing debug tools..."
      #     cp /bin/busybox /debug-tools/
      #     /debug-tools/busybox --install -s /debug-tools/
      #     echo "Debug tools installed successfully"
      #   volumeMounts:
      #   - name: debug-tools
      #     mountPath: /debug-tools
      
      containers:
      - name: xuanwu-factory-next
        image: nexus.aimstek.cn/xuanwu-factory/xuanwu-factory-next:dev-251126-155059
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: port-3000-0
          containerPort: 3000
          protocol: TCP
        - name: port-3001-1
          containerPort: 3001
          protocol: TCP
        
        env:
        - name: WS_URL
          value: ws://xuanwu-factory-next-ws.xuanwu-factory.dev.aimstek.cn
        - name: DATABASE_URL
          value: mysql://root:root@192.168.154.154:3306/xuanwu_next
        - name: JENKINS_USER
          value: xuanwu
        - name: JENKINS_BASE_URL
          value: http://192.168.44.121
        - name: JENKINS_JOB_NAME
          value: CICD-STD/build-by-dockerfile
        - name: JENKINS_API_TOKEN
          value: 1112e29a2d923515b98730268f45a01d3c
        
        resources: {}
        
        # 可选：挂载调试工具卷（配合 init container 使用）
        # volumeMounts:
        # - name: debug-tools
        #   mountPath: /debug-tools
        
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30

---
# Service - xuanwu-factory-next
apiVersion: v1
kind: Service
metadata:
  name: xuanwu-factory-next
  namespace: xuanwu-factory
  labels:
    app: xuanwu-factory-next
    managed-by: xuanwu-platform
spec:
  type: ClusterIP
  selector:
    app: xuanwu-factory-next
  ports:
  - name: port-3000-0
    port: 3000
    targetPort: 3000
    protocol: TCP
  - name: port-3001-1
    port: 3001
    targetPort: 3001
    protocol: TCP
  sessionAffinity: None
  internalTrafficPolicy: Cluster

---
# Ingress - xuanwu-factory-next
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: xuanwu-factory-next-ingress
  namespace: xuanwu-factory
  labels:
    app: xuanwu-factory-next
    managed-by: xuanwu-platform
spec:
  ingressClassName: nginx
  rules:
  - host: xuanwu-factory-next.xuanwu-factory.dev.aimstek.cn
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: xuanwu-factory-next
            port:
              number: 3000
  - host: xuanwu-factory-next-ws.xuanwu-factory.dev.aimstek.cn
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: xuanwu-factory-next
            port:
              number: 3001
