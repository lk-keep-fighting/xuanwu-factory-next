# 需求管理模块（MVP）设计

## 1. 背景与目标

为了让团队可以以结构化方式管理产品/研发需求，并将需求内容高效派发给 AI 员工执行，本次新增“需求管理模块”。该模块需提供从需求录入、视图呈现、到与 AI 员工派发联动的最小可用能力，目标包括：

- 支撑产品/项目负责人集中录入与维护需求，包含 Markdown 详细描述与截止时间设置。
- 建立需求与项目/服务之间的关联，便于为 AI 员工提供执行上下文。
- 在需求视图中直接触发派发给 AI 员工的任务，形成闭环。
- 为后续迭代（需求拆解、评审、协作流程）奠定基础。

## 2. 术语与角色定义

| 概念 | 说明 |
| --- | --- |
| 需求（Requirement） | 待实现的产品/技术需求，包含标题、Markdown 描述、截止时间、状态等信息。 |
| 项目（Project） | 需求所属的业务项目或产品线，可复用现有项目域模型。 |
| 服务（Service） | 项目下的具体应用或代码仓，需求可关联一个或多个服务，用于 AI 执行上下文。 |
| AI 员工任务（AI Task） | 将需求派发给某个 AI 员工后生成的执行任务；与现有 `AITaskAssignment` 关联。 |
| 需求责任人 | 对需求整体负责的人类成员，可更改状态、触发派发、确认验收。 |

## 3. MVP 范围

- **需求录入与查看**：支持创建、编辑需求，字段含标题、Markdown 描述、截止时间、优先级、状态、责任人、关联项目/服务。
- **Markdown 支持**：需求详情使用 Markdown 编辑器，提供实时预览，数据库存储原始 Markdown 文本。
- **截止时间提醒（轻量）**：在列表中展示剩余时间，超时标记；实际提醒通知可延后。
- **需求列表与筛选**：按状态、项目、服务、责任人、是否逾期等条件筛选；支持关键字搜索。
- **派发给 AI 员工**：在需求详情页可选择一个或多个 AI 员工创建执行任务，自动携带需求上下文，形成需求-任务关联。
- **需求状态流转**：提供最小状态机（`草稿 Draft` → `待执行 Todo` → `执行中 InProgress` → `已完成 Done`，支持 `已取消 Canceled`），并记录状态变更历史。

## 4. 核心功能拆解

### 4.1 需求创建 / 编辑
- 表单字段：
  - 标题（必填，50 字内）。
  - 描述（Markdown，必填，支持插入代码块/列表/链接）。
  - 截止时间（可选，默认当天 +7 天）。
  - 优先级（枚举：Low/Medium/High）。
  - 状态（草稿/待执行）。
  - 关联项目（必选；来自现有项目数据）。
  - 关联服务（多选；根据项目联动过滤）。
  - 责任人（用户选择器，默认创建者）。
  - 关注人（可选，多选，用于订阅后续通知，MVP 中仅记录，不触发通知）。
- 支持草稿保存与直接进入待执行。
- Markdown 编辑器提供“编辑/预览/全屏”模式，前端采用已有 UI 库或引入轻量组件（如 `@uiw/react-md-editor`）。

### 4.2 需求详情页
- 左侧展示基础信息（标题、项目、服务标签、截止时间、优先级、状态、责任人）。
- 主体显示 Markdown 渲染后的需求描述，支持代码高亮。
- 右侧操作区：
  - 状态更新按钮（按当前状态展示下一步可选项）。
  - “派发给 AI 员工”操作入口。
  - 已关联的 AI 任务列表（状态、AI 员工、执行结果快照）。
  - 截止时间倒计时提示（逾期高亮）。
- 底部展示状态变更历史时间线。

### 4.3 需求列表
- 表格列：标题、项目、服务数、优先级、状态、责任人、截止时间（含剩余天数/逾期标记）、已派发任务数、最近更新。
- 过滤条件：状态（多选）、项目、服务、责任人、逾期、已派发/未派发。
- 支持关键字搜索（标题/描述全文）。
- 批量操作（MVP 限制为批量状态更新为“已取消”或批量指派责任人）。

### 4.4 派发给 AI 员工流程
1. 在需求详情点击“派发给 AI 员工”。
2. 打开派发表单，预置需求标题为任务标题，Markdown 描述作为任务描述，可补充执行要求。
3. 选择 AI 员工（单选/多选），可指定任务优先级与期望产出。
4. 选择项目、服务、分支：默认引用需求关联的项目/服务，允许编辑。
5. 提交后：
   - 针对每名 AI 员工调用现有 `/api/ai-employees/{id}/dispatch` 接口，创建 `AITaskAssignment`。
   - 在需求与任务之间写入关联记录，状态更新为“执行中”。
   - 前端展示任务创建结果与 Mock 返回的 Task ID。

### 4.5 状态与截止时间管理
- 状态变更需记录操作者、时间、备注（可选）。
- 当所有关联 AI 任务完成后，提示责任人将需求状态改为“已完成”。
- 若需求长期未派发或逾期，列表中高亮并支持按需提醒（后续迭代加入通知）。

## 5. 业务流程概览

1. **录入需求**：产品负责人创建草稿 → 补充描述、关联项目/服务 → 保存为待执行。
2. **派发执行**：责任人或项目负责人在需求详情中选择 AI 员工派发任务，同时需求状态切换为执行中。
3. **执行反馈**：AI 员工任务完成后，需求详情更新关联任务状态，责任人确认交付并将需求状态置为已完成。
4. **持续维护**：可随时编辑需求描述、调整截止时间；状态历史记录提供追溯能力。

## 6. 数据模型设计（Prisma 风格草案）

> 具体命名需与现有数据库规范对齐，以下为建议字段。

### 6.1 Requirement

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | string (UUID) | 主键 |
| title | string | 需求标题 |
| description | text | Markdown 原文 |
| descriptionHtml | text | 预渲染 HTML（可选缓存字段，前端也可动态渲染） |
| status | enum("DRAFT","TODO","IN_PROGRESS","DONE","CANCELED") | 状态 |
| priority | enum("LOW","MEDIUM","HIGH") | 优先级 |
| projectId | string | 关联项目 ID |
| dueAt | datetime | 截止时间（可为空） |
| ownerId | string | 责任人 |
| watcherIds | string[] | 关注人列表（可映射多对多表） |
| aiTaskCount | int | 已派发 AI 任务数量（冗余更新） |
| lastAiDispatchAt | datetime | 最近派发时间 |
| createdBy | string | 创建人 |
| createdAt/updatedAt | datetime | 时间戳 |

### 6.2 RequirementServiceLink

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | string | 主键 |
| requirementId | string | 关联需求 |
| serviceId | string | 关联服务/应用 |
| createdAt | datetime | 创建时间 |

> 若服务数据来自现有表，可通过外键连接；否则使用字符串 ID 与外部系统对接。

### 6.3 RequirementTaskLink

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | string | 主键 |
| requirementId | string | 关联需求 |
| aiTaskAssignmentId | string | 关联 `AITaskAssignment` |
| aiEmployeeId | string | 被派发的 AI 员工 |
| statusSnapshot | enum | 创建时的任务状态缓存，加快列表展示 |
| createdAt/updatedAt | datetime | 时间戳 |

### 6.4 RequirementStatusHistory

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | string | 主键 |
| requirementId | string | 对应需求 |
| fromStatus | enum | 原状态 |
| toStatus | enum | 目标状态 |
| changedBy | string | 操作人 |
| note | string | 备注（可空） |
| createdAt | datetime | 变更时间 |

> Watcher 映射如需支持多租户/多项目可拆为 `RequirementWatcher` 关联表。

## 7. API 设计（MVP）

| 接口 | 方法 | 描述 |
| --- | --- | --- |
| `/api/requirements` | GET | 分页查询需求，支持状态/项目/服务/责任人/逾期/关键词过滤。 |
| `/api/requirements` | POST | 新增需求。 |
| `/api/requirements/{id}` | GET | 获取需求详情（含 Markdown、任务关联）。 |
| `/api/requirements/{id}` | PATCH | 更新需求字段、状态、截止时间等。 |
| `/api/requirements/{id}/dispatch-ai` | POST | 派发需求给 AI 员工，生成 `AITaskAssignment` 并写入关联。 |
| `/api/requirements/{id}/status-history` | GET | 查询状态变更历史。 |
| `/api/requirements/{id}/watchers` | PATCH | 更新关注人列表（MVP 可与主 PATCH 合并）。 |

### `/api/requirements/{id}/dispatch-ai` 请求示例
```json
{
  "aiEmployeeIds": ["ai-emp-001", "ai-emp-101"],
  "taskConfig": {
    "branch": "feature/requirement-123",
    "expectedOutputs": ["design doc", "implementation plan"],
    "priority": "HIGH"
  }
}
```

服务器处理逻辑：
1. 校验需求状态（仅 TODO/IN_PROGRESS 可派发）。
2. 根据需求关联项目/服务自动补全派发表单上下文。
3. 针对每个 AI 员工调用既有派发接口，若失败则记录失败信息并返回部分成功结果。
4. 更新需求记录：`aiTaskCount`、`lastAiDispatchAt`，若状态为 TODO 则切换为 IN_PROGRESS。

## 8. 前端页面设计

1. **需求列表页**
   - 顶部统计（需求总数、进行中、逾期）。
   - 筛选器区 + 表格（支持列宽调整、状态标签）。
   - 创建需求按钮。

2. **需求创建/编辑抽屉或全页表单**
   - 左侧基础字段，右侧 Markdown 编辑器。
   - 支持草稿保存与立即发布。

3. **需求详情页**
   - Header：标题、状态、操作按钮（派发、编辑、更多）。
   - 主体：Markdown 渲染，任务关联列表（表格/卡片），状态历史时间线。
   - 信息侧栏：项目、服务标签、截止时间、责任人、关注人。

4. **派发给 AI 员工弹窗**
   - 步骤：选择员工 → 校验上下文 → 确认内容。
   - 显示派发结果，失败项提示可重试。

5. **移动端响应式（可延后）**
   - MVP 确保桌面端体验优先，移动端仅保证基本可读性。

## 9. 与现有系统集成

- **项目 / 服务数据源**：复用现有项目管理模块的查询接口；若缺失需提供 `/api/projects`、`/api/services?projectId=` 等基础数据接口。
- **AI 员工模块**：派发接口复用 `/api/ai-employees/{id}/dispatch`，并在需求端维护任务关联；需求详情页需调用 AI 员工任务列表 API。
- **审计与权限**：
  - 审计：需求创建、编辑、状态变更、AI 派发均记录到 `AuditLog`（新增事件类型 `REQUIREMENT_*`）。
  - 权限：引入“需求管理员”“需求编辑者”“只读”三类权限，与现有 RBAC 体系整合。
- **通知系统（留待迭代）**：未来可在截止时间临近或状态变更时触发站内信/邮件/IM 通知。

## 10. 技术实现要点

- **Markdown 存储与渲染**：
  - 存储 Markdown 原文，服务端或前端使用同一渲染策略（前端可用 `react-markdown` + `rehype-highlight`）。
  - 为提高列表性能，可在保存时异步生成 `descriptionHtml` 缓存。
- **列表查询性能**：
  - 对 `status`、`projectId`、`dueAt` 建立索引。
  - `aiTaskCount` 作为冗余字段避免实时聚合，可通过触发器或事务更新。
- **状态机控制**：
  - 在服务层集中定义允许的状态迁移（如 Draft → Todo/InProgress；InProgress → Done/Canceled）。
  - 状态变更写入 `RequirementStatusHistory`。
- **派发事务性**：
  - 创建 RequirementTaskLink + 调用派发 API 使用事务/补偿机制，确保部分失败可回滚或标记。
  - 派发接口调用失败时需返回失败列表并在 UI 上提示重试。
- **权限校验**：
  - 创建/编辑操作需校验用户在项目维度的权限。
  - 派发操作需校验用户具备 AI 任务派发权限。

## 11. 迭代计划

| 阶段 | 范围 | 交付物 |
| --- | --- | --- |
| Phase 0 | 设计评审 | 本设计文档，经评审确认范围。 |
| Phase 1 | 基础数据层 | Prisma 模型、数据库迁移、需求 CRUD API、列表/详情前端页面。 |
| Phase 2 | AI 派发整合 | 派发表单、与 AI 员工接口联动、需求状态自动流转、任务关联展示。 |
| Phase 3 | 体验优化 | Markdown 增强（模板、附件）、截止时间提醒、批量操作与搜索体验优化。 |
| Phase 4 | 协作流程 | 需求拆解子任务、评审流程、评论与通知集成。 |

## 12. 风险与待确认项

1. **项目/服务数据一致性**：需确认是否已有统一的项目 & 服务主数据接口；若无需并行建设数据源。
2. **AI 派发失败处理**：若单个 AI 员工派发失败，如何提示与重试策略需明确。
3. **Markdown 安全**：渲染 HTML 时需做 XSS 过滤（可使用 `rehype-sanitize`）。
4. **权限模型颗粒度**：需求是否跨项目共享，涉及复杂权限矩阵（可在 MVP 中限定同项目内共享）。
5. **后续扩展兼容**：需求拆分为多个子需求、与工单/测试用例联动等需求需预留数据结构可扩展性。

---

本设计文档聚焦需求管理模块的 MVP 落地方案，后续可根据评审与实际落地情况迭代更新。
