# 功能：资源限制配置

## 概述

实现服务的 CPU 和内存资源限制配置功能，允许用户为服务设置资源请求（Requests）和限制（Limits），确保服务在 Kubernetes 集群中合理使用资源。

## 功能特性

### 1. 资源配置项

#### CPU 配置
- **CPU 限制（Limit）**：容器可以使用的最大 CPU 资源
  - 单位：m (毫核) 或 core (核)
  - 1 core = 1000m
  - 建议范围：100m - 2000m

- **CPU 请求（Request）**：容器启动时保证分配的 CPU 资源
  - 单位：m (毫核) 或 core (核)
  - 建议范围：50m - 1000m
  - 必须 ≤ CPU 限制

#### 内存配置
- **内存限制（Limit）**：容器可以使用的最大内存
  - 单位：Mi (兆字节) 或 Gi (吉字节)
  - 1 Gi = 1024 Mi
  - 建议范围：128Mi - 2Gi

- **内存请求（Request）**：容器启动时保证分配的内存
  - 单位：Mi (兆字节) 或 Gi (吉字节)
  - 建议范围：64Mi - 1Gi
  - 必须 ≤ 内存限制

### 2. 快速预设

提供三种常用配置预设，一键应用：

#### 小型服务
- CPU 限制：100m
- CPU 请求：50m
- 内存限制：128Mi
- 内存请求：64Mi
- **适用场景**：轻量级服务、定时任务、工具类服务

#### 中型服务
- CPU 限制：500m
- CPU 请求：250m
- 内存限制：512Mi
- 内存请求：256Mi
- **适用场景**：标准 Web 应用、API 服务、微服务

#### 大型服务
- CPU 限制：2 core
- CPU 请求：1 core
- 内存限制：2Gi
- 内存请求：1Gi
- **适用场景**：高负载应用、数据处理服务、缓存服务

### 3. 实时验证

#### 错误验证
- CPU/内存值必须是正数
- CPU 请求不能大于 CPU 限制
- 内存请求不能大于内存限制

#### 警告提示
- CPU 限制过低（< 10m）
- 内存限制过低（< 64Mi）
- 可能导致服务无法正常运行

### 4. 使用说明

在配置界面顶部提供信息提示：
- 限制（Limits）的作用和影响
- 请求（Requests）的作用和影响
- 配置建议和注意事项

## 界面设计

### 布局结构

```
┌─────────────────────────────────────────┐
│ 📘 资源配置说明                          │
│ • 限制（Limits）：最大资源量             │
│ • 请求（Requests）：保证分配的资源量     │
│ • 请求值应小于或等于限制值               │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ❌ 配置错误（如有）                      │
│ • CPU 请求不能大于 CPU 限制              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ⚠️  配置警告（如有）                     │
│ • CPU 限制过低，可能导致服务无法正常运行 │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 资源限制（Limits）                       │
│                                          │
│ CPU 限制        内存限制                 │
│ [500] [m ▼]    [512] [Mi ▼]            │
│ 1 core = 1000m  1 Gi = 1024 Mi          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 资源请求（Requests）                     │
│                                          │
│ CPU 请求        内存请求                 │
│ [250] [m ▼]    [256] [Mi ▼]            │
│ 保证分配的资源   保证分配的资源          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 快速预设                                 │
│                                          │
│ [小型服务]  [中型服务]  [大型服务]       │
│ 100m/50m    500m/250m   2core/1core     │
│ 128Mi/64Mi  512Mi/256Mi 2Gi/1Gi         │
└─────────────────────────────────────────┘
```

## 技术实现

### 组件结构

```
ResourcesSection
  ├── 信息提示（Alert）
  ├── 验证错误提示（Alert）
  ├── 验证警告提示（Alert）
  ├── 资源限制表单
  │   ├── CPU 限制输入
  │   │   ├── 数值输入框
  │   │   └── 单位选择器（m / core）
  │   └── 内存限制输入
  │       ├── 数值输入框
  │       └── 单位选择器（Mi / Gi）
  ├── 资源请求表单
  │   ├── CPU 请求输入
  │   │   ├── 数值输入框
  │   │   └── 单位选择器（m / core）
  │   └── 内存请求输入
  │       ├── 数值输入框
  │       └── 单位选择器（Mi / Gi）
  └── 快速预设按钮组
      ├── 小型服务
      ├── 中型服务
      └── 大型服务
```

### 状态管理

#### 本地状态
- `localCpuValue`: CPU 限制数值
- `localCpuUnit`: CPU 限制单位
- `localMemoryValue`: 内存限制数值
- `localMemoryUnit`: 内存限制单位
- `localCpuRequestValue`: CPU 请求数值
- `localCpuRequestUnit`: CPU 请求单位
- `localMemoryRequestValue`: 内存请求数值
- `localMemoryRequestUnit`: 内存请求单位

#### 状态同步
1. **非编辑模式**：从 props 同步到本地状态
2. **编辑模式**：本地状态变化时通知父组件
3. **保存时**：父组件将数据保存到服务器

### 数据转换

使用 `resource-utils` 工具函数：

```typescript
// 解析资源值
parseResourceValue('500m', 'cpu')
// => { value: '500', unit: 'm' }

// 组合资源值
combineResourceValue('500', 'm')
// => '500m'
```

### 验证逻辑

```typescript
const validation = useMemo(() => {
  const errors: string[] = []
  const warnings: string[] = []

  // 1. 验证数值有效性
  if (cpuValue && (isNaN(cpuValue) || cpuValue <= 0)) {
    errors.push('CPU 限制必须是正数')
  }

  // 2. 验证请求 ≤ 限制
  if (cpuRequest > cpuLimit) {
    errors.push('CPU 请求不能大于 CPU 限制')
  }

  // 3. 检查资源是否过低
  if (cpuLimit < 10m) {
    warnings.push('CPU 限制过低')
  }

  return { errors, warnings, valid: errors.length === 0 }
}, [cpuValue, cpuUnit, memoryValue, ...])
```

## 使用场景

### 场景 1：为新服务设置资源限制

1. 创建服务后，进入服务详情页
2. 切换到"服务配置"标签
3. 滚动到"资源限制"部分
4. 点击"编辑配置"
5. 选择合适的预设或手动输入
6. 点击"保存"
7. 重新部署服务使配置生效

### 场景 2：调整现有服务的资源配置

1. 进入服务详情页
2. 切换到"服务配置"标签
3. 查看当前资源配置
4. 点击"编辑配置"
5. 根据实际使用情况调整
6. 点击"保存"
7. 重新部署服务

### 场景 3：使用快速预设

1. 点击"编辑配置"
2. 在"快速预设"区域选择合适的预设
3. 系统自动填充所有资源配置
4. 可以在预设基础上微调
5. 点击"保存"

## Kubernetes 资源映射

配置会映射到 Kubernetes Deployment 的资源定义：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service
spec:
  template:
    spec:
      containers:
      - name: app
        image: my-image:latest
        resources:
          limits:
            cpu: "500m"      # CPU 限制
            memory: "512Mi"  # 内存限制
          requests:
            cpu: "250m"      # CPU 请求
            memory: "256Mi"  # 内存请求
```

## 资源配置建议

### 开发环境
- 使用"小型服务"预设
- 节省集群资源
- 满足基本开发需求

### 测试环境
- 使用"中型服务"预设
- 接近生产环境配置
- 便于性能测试

### 生产环境
- 根据实际监控数据调整
- 设置合理的请求值确保调度
- 设置适当的限制值防止资源耗尽
- 建议：请求值 = 平均使用量，限制值 = 峰值使用量 × 1.2

## 常见问题

### Q1: 不设置资源限制会怎样？
A: 容器可以使用节点上的所有可用资源，可能导致：
- 影响其他服务
- 节点资源耗尽
- 服务被驱逐

### Q2: 请求和限制有什么区别？
A: 
- **请求（Request）**：调度器用于决定将 Pod 放在哪个节点，保证分配
- **限制（Limit）**：运行时强制执行，超过限制会被限流或终止

### Q3: 如何确定合适的资源配置？
A: 
1. 先使用预设配置
2. 部署后观察"概览"标签页的资源使用图表
3. 根据实际使用情况调整
4. 建议：限制值 = 峰值使用量 × 1.2

### Q4: CPU 单位 m 和 core 如何选择？
A: 
- 小于 1 core 建议使用 m（如 100m、500m）
- 大于等于 1 core 建议使用 core（如 1 core、2 core）
- 1 core = 1000m

### Q5: 修改资源配置后需要重启吗？
A: 是的，需要重新部署服务才能使新的资源配置生效。

## 相关文件

- `src/components/services/configuration/ResourcesSection.tsx` - 资源配置组件
- `src/components/services/ConfigurationTab.tsx` - 配置标签页
- `src/lib/resource-utils.ts` - 资源值解析和转换工具
- `src/types/service-tabs.ts` - 类型定义

## 后续优化建议

1. **智能推荐**
   - 基于历史监控数据推荐资源配置
   - 根据服务类型提供默认配置

2. **资源使用预警**
   - 当实际使用接近限制时发出警告
   - 建议调整资源配置

3. **成本估算**
   - 显示资源配置对应的成本
   - 帮助用户优化资源使用

4. **批量配置**
   - 支持为多个服务批量设置资源限制
   - 提供项目级别的资源配置模板

## 测试建议

### 功能测试
- [ ] 输入有效的资源值
- [ ] 输入无效的资源值（负数、非数字）
- [ ] 请求值大于限制值
- [ ] 使用快速预设
- [ ] 切换单位（m ↔ core, Mi ↔ Gi）
- [ ] 保存和取消操作

### 验证测试
- [ ] 错误提示正确显示
- [ ] 警告提示正确显示
- [ ] 验证逻辑正确

### 集成测试
- [ ] 配置保存到数据库
- [ ] 部署时应用到 Kubernetes
- [ ] 资源监控正确显示

## 发布日期

2024-12-04

## 版本

v1.0
